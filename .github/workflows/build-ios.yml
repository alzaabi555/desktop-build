name: Build iOS App

on:
  workflow_dispatch:
  push:
    branches: [main]
    paths:
      - 'main.py'
      - 'requirements.txt'
      - '.github/workflows/**'

jobs:
  build-ios:
    runs-on: macos-14
    env:
      APP_NAME: "StudentBehavior"
      
    steps:
      # 1. ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙƒÙˆØ¯
      - name: ğŸ“¥ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹
        uses: actions/checkout@v4
      
      # 2. Ø¥Ø¹Ø¯Ø§Ø¯ Python
      - name: ğŸ Ø¥Ø¹Ø¯Ø§Ø¯ Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      # 3. ØªØ«Ø¨ÙŠØª Ø§Ù„Ù…ÙƒØªØ¨Ø§Øª
      - name: ğŸ“¦ ØªØ«Ø¨ÙŠØª Ø§Ù„Ù…ØªØ·Ù„Ø¨Ø§Øª
        run: |
          pip install -r requirements.txt
      
      # 4. Ø¥Ø¹Ø¯Ø§Ø¯ Flutter
      - name: ğŸš€ Ø¥Ø¹Ø¯Ø§Ø¯ Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.22.0'
          channel: 'stable'
      
      # 5. ØªØ«Ø¨ÙŠØª CocoaPods
      - name: ğŸ“± ØªØ«Ø¨ÙŠØª CocoaPods
        run: |
          sudo gem install cocoapods
          pod setup
      
      # 6. Ø¨Ù†Ø§Ø¡ ØªØ·Ø¨ÙŠÙ‚ iOS
      - name: ğŸ”¨ Ø¨Ù†Ø§Ø¡ ØªØ·Ø¨ÙŠÙ‚ iOS
        run: |
          flet build ipa . \
            --project "$APP_NAME" \
            --org "com.education" \
            --ios-language "ar" \
            --ios-country "SA" \
            --verbose
      
      # 7. Ø¥ØµÙ„Ø§Ø­ Ø§Ù„Ø´Ø§Ø´Ø© Ø§Ù„Ø¨ÙŠØ¶Ø§Ø¡
      - name: âš¡ Ø¥ØµÙ„Ø§Ø­ iOS
        run: |
          # ØªØ¹Ø·ÙŠÙ„ Impeller
          find . -name "Info.plist" | head -1 | while read plist; do
            /usr/libexec/PlistBuddy -c "Add :FLTEnableImpeller bool false" "$plist"
          done
      
      # 8. ØªØ¬Ù…ÙŠØ¹ IPA
      - name: ğŸ“¦ ØªØ¬Ù…ÙŠØ¹ IPA
        run: |
          mkdir -p Payload
          find . -name "*.app" -type d | head -1 | while read app; do
            cp -r "$app" Payload/
            zip -qr "ØªØ·Ø¨ÙŠÙ‚_Ø³Ù„ÙˆÙƒÙŠØ§Øª_Ø§Ù„Ø·Ù„Ø¨Ø©.ipa" Payload
          done
      
      # 9. Ø±ÙØ¹ Ø§Ù„Ù†Ø§ØªØ¬
      - name: â¬†ï¸ Ø±ÙØ¹ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
        uses: actions/upload-artifact@v4
        with:
          name: ØªØ·Ø¨ÙŠÙ‚-iOS
          path: "*.ipa"
